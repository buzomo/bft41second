<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ–‡å­¦ãƒ•ãƒªãƒæ±äº¬41 ãƒãƒƒãƒ— (æ”¹è‰¯ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#333333">

    <style>
        :root {
            --color-want: #ff0080;
            --color-visited: #00ba2f;
            --color-bg-1f: #e6f7ff;
            --color-bg-4f: #fff8f1;
            --color-tab-1f: #87ceeb;
            --color-tab-4f: #ffa500;
            
            /* å„ªå…ˆåº¦ã‚«ãƒ©ãƒ¼ */
            --prio-high: #ff0080; /* Pink */
            --prio-mid: #ff8c00;  /* Orange */
            --prio-low: #ffd700;  /* Gold */
        }

        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #f5f5f5;
            user-select: none;
            -webkit-user-select: none;
        }

        /* --- Header & Utility --- */
        #header-area {
            background: #333;
            color: white;
            padding: 8px;
            flex-shrink: 0;
            display: grid;
            grid-template-columns: 40px 1fr 80px;
            align-items: center;
            z-index: 100;
            transition: background-color 0.3s;
        }
        #header-area.read-only {
            background: #5e35b1; /* é–²è¦§ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯ç´« */
        }

        .header-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 18px;
            padding: 0;
        }
        .header-btn span { font-size: 9px; margin-top: 2px; }

        .title-group { text-align: center; }
        .title-text { font-weight: bold; font-size: 16px; }
        #timer-display { font-size: 12px; margin-top: 2px; }

        #progress-bar-container {
            height: 4px;
            background: #555;
            width: 100%;
            margin-top: 5px;
            grid-column: 1 / -1;
        }
        #progress-bar { height: 100%; background: #4caf50; width: 0%; transition: width 0.3s; }

        /* --- Tabs --- */
        #tab-area { display: flex; background: #444; flex-shrink: 0; }
        .tab {
            flex: 1;
            text-align: center;
            padding: 8px 4px;
            cursor: pointer;
            color: #ccc;
            background: #333;
            border-bottom: 4px solid transparent;
            transition: all 0.2s;
        }
        .tab.active { color: white; background: #555; }
        .tab[data-floor="1F"].active { border-bottom-color: var(--color-tab-1f); }
        .tab[data-floor="4F"].active { border-bottom-color: var(--color-tab-4f); }

        .tab-info { font-size: 14px; font-weight: bold; }
        .tab-stats { font-size: 10px; margin-top: 4px; display: flex; justify-content: center; gap: 8px; }
        .stat-badge { padding: 1px 6px; border-radius: 10px; background: rgba(255,255,255,0.1); }

        /* --- Map Area --- */
        .map-wrapper {
            flex-grow: 1;
            position: relative;
            overflow: hidden;
            background: #ddd;
            display: none;
        }
        .map-wrapper.active { display: block; }
        #map-container-1F { background: var(--color-bg-1f); }
        #map-container-4F { background: var(--color-bg-4f); }

        .scroll-surface {
            position: absolute;
            transform-origin: 0 0;
            cursor: grab;
            touch-action: none; /* ãƒ”ãƒ³ãƒæ“ä½œç­‰ã¯JSã§åˆ¶å¾¡ */
        }
        .scroll-surface:active { cursor: grabbing; }

        /* --- Booth Styles --- */
        .booth {
            width: 44px;
            height: 40px;
            background: #fff;
            border: 1px solid #999;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 14px;
            position: relative;
            box-sizing: border-box;
            color: #333;
        }
        .booth.empty { border: none; background: transparent; }
        
        /* Status Colors */
        .booth[data-status="1"] { /* Want */
            background-color: white !important; /* èƒŒæ™¯ã¯ç™½ã€æ ç·šã§è¡¨ç¾ */
            color: #333;
            border-width: 3px;
        }
        /* Priority Borders */
        .booth[data-status="1"][data-prio="3"] { border-color: var(--prio-high); z-index: 2; } /* High */
        .booth[data-status="1"][data-prio="2"] { border-color: var(--prio-mid); z-index: 2; } /* Mid */
        .booth[data-status="1"][data-prio="1"] { border-color: var(--prio-low); z-index: 2; } /* Low */
        .booth[data-status="1"]:not([data-prio]) { border-color: var(--color-want); } /* Default */

        .booth[data-status="2"] { /* Visited */
            background-color: var(--color-visited) !important;
            color: white;
            border-color: #008020;
        }
        
        /* Highlight (Search/Select) */
        .booth.highlight {
            box-shadow: 0 0 0 4px yellow;
            z-index: 10;
            animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% { box-shadow: 0 0 0 2px yellow; } 50% { box-shadow: 0 0 0 6px yellow; } 100% { box-shadow: 0 0 0 2px yellow; } }

        /* Map Layout Classes (Keep original structure mostly) */
        .island-row { display: flex; margin-bottom: 16px; position: relative; }
        .island-container { display: flex; flex-direction: column; margin-right: 20px; }
        .island-section { display: flex; gap: 4px; margin-bottom: 4px; }
        .block-row { display: flex; gap: 2px; }
        .block-column { display: flex; flex-direction: column; gap: 2px; }
        .big-letter {
            position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
            font-size: 100px; font-weight: 900; color: rgba(0,0,0,0.05); pointer-events: none;
        }
        /* Simplified layout helpers */
        .spacer { width: 40px; }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 1000;
            display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; width: 90%; max-width: 350px;
            border-radius: 12px; padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            max-height: 90vh; overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-title { font-size: 20px; font-weight: bold; margin: 0; }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; padding: 0 8px; }

        /* Booth Detail Specifics */
        .info-row { margin-bottom: 12px; }
        .info-label { display: block; font-size: 12px; color: #666; margin-bottom: 4px; }
        .status-actions { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin: 15px 0; }
        .status-btn {
            padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;
            color: white; opacity: 0.4; transition: opacity 0.2s, transform 0.1s;
        }
        .status-btn.active { opacity: 1; transform: scale(1.05); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        #btn-unset { background: #999; }
        #btn-want { background: var(--color-want); }
        #btn-visited { background: var(--color-visited); }

        .priority-selector {
            display: flex; gap: 10px; margin-top: 8px; justify-content: center;
            background: #f0f0f0; padding: 8px; border-radius: 6px;
        }
        .prio-opt {
            display: flex; align-items: center; gap: 4px; font-size: 12px; cursor: pointer;
        }
        .visit-time { font-size: 12px; color: #00ba2f; text-align: center; margin-top: 5px; }

        /* List View (Drawer) */
        #list-drawer {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 50vh;
            background: white; z-index: 500;
            border-top-left-radius: 16px; border-top-right-radius: 16px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            transform: translateY(100%); transition: transform 0.3s ease;
            display: flex; flex-direction: column;
        }
        #list-drawer.open { transform: translateY(0); }
        .drawer-header { padding: 15px; border-bottom: 1px solid #eee; text-align: center; font-weight: bold; position: relative; }
        .drawer-close { position: absolute; right: 15px; top: 15px; cursor: pointer; }
        .list-content { overflow-y: auto; flex: 1; padding: 10px; }
        .list-item {
            padding: 10px; border-bottom: 1px solid #f0f0f0;
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer;
        }
        .list-item:hover { background: #f9f9f9; }
        .badge-prio { font-size: 10px; padding: 2px 6px; border-radius: 4px; color: white; margin-right: 5px; }

        /* Toast Notification */
        #toast {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 8px 16px; border-radius: 20px;
            font-size: 14px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 2000;
        }
        #toast.show { opacity: 1; }

        /* Read Only Mode Banner */
        #readonly-banner {
            background: #ffeb3b; color: #333; text-align: center; font-size: 12px; padding: 5px;
            position: fixed; bottom: 0; width: 100%; z-index: 2000; display: none;
        }
    </style>
</head>

<body>

    <div id="header-area">
        <div style="display: flex; gap: 10px;">
            <button class="header-btn" id="btn-menu" title="è¨­å®š">
                <span>âš™ï¸</span><span>è¨­å®š</span>
            </button>
        </div>
        <div class="title-group">
            <div class="title-text">æ–‡å­¦ãƒ•ãƒªãƒæ±äº¬41</div>
            <div id="timer-display">Loading...</div>
        </div>
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button class="header-btn" id="btn-search">
                <span>ğŸ”</span><span>æ¤œç´¢</span>
            </button>
            <button class="header-btn" id="btn-share">
                <span>ğŸ“¤</span><span>å…±æœ‰</span>
            </button>
        </div>
        <div id="progress-bar-container">
            <div id="progress-bar"></div>
        </div>
    </div>

    <div id="tab-area">
        <div class="tab active" data-floor="1F">
            <div class="tab-info">å—1ãƒ»2 (1F)</div>
            <div class="tab-stats">
                <span class="stat-badge" style="color:var(--color-want)">è¡ŒããŸã„:<span id="cnt-want-1f">0</span></span>
                <span class="stat-badge" style="color:var(--color-visited)">æ¸ˆ:<span id="cnt-visit-1f">0</span></span>
            </div>
        </div>
        <div class="tab" data-floor="4F">
            <div class="tab-info">å—3ãƒ»4 (4F)</div>
            <div class="tab-stats">
                <span class="stat-badge" style="color:var(--color-want)">è¡ŒããŸã„:<span id="cnt-want-4f">0</span></span>
                <span class="stat-badge" style="color:var(--color-visited)">æ¸ˆ:<span id="cnt-visit-4f">0</span></span>
            </div>
        </div>
    </div>

    <div id="map-container-1F" class="map-wrapper active">
        <div class="scroll-surface" id="surface-1F">
            </div>
    </div>
    <div id="map-container-4F" class="map-wrapper">
        <div class="scroll-surface" id="surface-4F">
             </div>
    </div>

    <div id="list-drawer">
        <div class="drawer-header">
            <span id="drawer-title">ãƒªã‚¹ãƒˆ</span>
            <span class="drawer-close" onclick="UI.toggleList(false)">âœ•</span>
        </div>
        <div class="list-content" id="drawer-list"></div>
    </div>

    <div id="modal-booth" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="m-booth-id">A-00</h3>
                <button class="close-btn" onclick="UI.closeModal('modal-booth')">Ã—</button>
            </div>
            <div class="info-row">
                <div id="m-circle-name" style="font-size:18px; font-weight:bold; color:royalblue;"></div>
                <div id="m-genre" style="font-size:12px; background:#eee; display:inline-block; padding:2px 6px; border-radius:4px; margin-top:4px;"></div>
            </div>

            <div class="info-label">çŠ¶æ…‹:</div>
            <div class="status-actions">
                <button class="status-btn" id="btn-unset" onclick="Data.setStatus(CurrentBooth, 0)">æœª</button>
                <button class="status-btn" id="btn-want" onclick="Data.setStatus(CurrentBooth, 1)">è¡ŒããŸã„</button>
                <button class="status-btn" id="btn-visited" onclick="Data.setStatus(CurrentBooth, 2)">è¨ªå•æ¸ˆ</button>
            </div>

            <div id="area-priority" style="display:none;">
                <div class="info-label" style="text-align:center">å„ªå…ˆåº¦</div>
                <div class="priority-selector">
                    <label class="prio-opt"><input type="radio" name="prio" value="3" onchange="Data.setPriority(CurrentBooth, 3)"> <span style="color:var(--prio-high);font-weight:bold">é«˜</span></label>
                    <label class="prio-opt"><input type="radio" name="prio" value="2" onchange="Data.setPriority(CurrentBooth, 2)"> <span style="color:var(--prio-mid);font-weight:bold">ä¸­</span></label>
                    <label class="prio-opt"><input type="radio" name="prio" value="1" onchange="Data.setPriority(CurrentBooth, 1)"> <span style="color:var(--prio-low);font-weight:bold">ä½</span></label>
                </div>
            </div>
            
            <div id="area-timestamp" style="display:none;">
                <div class="visit-time" id="txt-timestamp"></div>
            </div>

            <div class="info-row" style="margin-top:15px;">
                <label class="info-label">ä¸€è¨€ãƒ¡ãƒ¢:</label>
                <textarea id="m-memo" rows="2" style="width:100%; border:1px solid #ddd; border-radius:4px;" onchange="Data.setMemo(CurrentBooth, this.value)"></textarea>
            </div>
            <div class="info-row">
                <label class="info-label">é‡‘é¡(å††):</label>
                <input type="number" id="m-amount" style="width:100%; border:1px solid #ddd; padding:5px;" onchange="Data.setAmount(CurrentBooth, this.value)">
            </div>
        </div>
    </div>

    <div id="modal-search" class="modal-overlay">
        <div class="modal-content" style="height: 60vh;">
             <div class="modal-header">
                <h3 class="modal-title">æ¤œç´¢</h3>
                <button class="close-btn" onclick="UI.closeModal('modal-search')">Ã—</button>
            </div>
            <input type="text" id="inp-search" placeholder="ã‚µãƒ¼ã‚¯ãƒ«åãƒ»ãƒ–ãƒ¼ã‚¹ç•ªå·" style="width:100%; padding:10px; font-size:16px; box-sizing:border-box; margin-bottom:10px;">
            <div id="search-results" style="overflow-y:auto; height:calc(100% - 60px);"></div>
        </div>
    </div>

    <div id="modal-share" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">å…±æœ‰ãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h3>
                <button class="close-btn" onclick="UI.closeModal('modal-share')">Ã—</button>
            </div>
            <p style="font-size:12px; color:#666;">URLã‚’é€ã‚‹ã“ã¨ã§ã€ç¾åœ¨ã®ãƒãƒ¼ã‚¯çŠ¶æ³ã‚’å…±æœ‰ã§ãã¾ã™ã€‚</p>
            <div id="qrcode" style="display:flex; justify-content:center; margin:10px;"></div>
            <input type="text" id="share-url" readonly style="width:100%; padding:8px; font-size:12px; border:1px solid #ddd; text-align:center;" onclick="this.select();document.execCommand('copy');UI.toast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ')">
            <hr>
            <div style="font-size:14px; font-weight:bold; margin-bottom:5px;">åˆè¨ˆä½¿ç”¨é‡‘é¡: <span id="share-total">0</span>å††</div>
            <button onclick="Data.downloadMemos()" style="width:100%; padding:10px; background:#4caf50; color:white; border:none; border-radius:4px; margin-top:5px;">ãƒ¡ãƒ¢ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰(txt)</button>
            <button onclick="Data.resetAll()" style="width:100%; padding:10px; background:#ff4444; color:white; border:none; border-radius:4px; margin-top:10px;">å…¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
    </div>

    <div id="toast"></div>
    <div id="readonly-banner">
        é–²è¦§ãƒ¢ãƒ¼ãƒ‰ï¼ˆä¿å­˜ã•ã‚Œã¾ã›ã‚“ï¼‰ 
        <button onclick="App.exitReadOnly()" style="margin-left:10px;border:1px solid #333;background:white;cursor:pointer">è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã«æˆ»ã‚‹</button>
    </div>

    <script>
        /* * Data Structure:
         * boothUserData = {
         * "A01": { 
         * s: 0-2 (status), 
         * p: 1-3 (priority), 
         * t: timestamp, 
         * m: "memo", 
         * a: 100 (amount) 
         * }
         * }
         */

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å®šæ•°
        const EVENT_DATE = "2025-11-23"; // æ–‡ãƒ•ãƒª41é–‹å‚¬æ—¥
        let CurrentBooth = null;
        let BoothsInfo = {}; // å¤–éƒ¨JSONã‹ã‚‰èª­ã¿è¾¼ã‚€
        let IsReadOnly = false;

        // ==========================================
        // Data Manager
        // ==========================================
        const Data = {
            store: {}, // ãƒ¡ãƒ¢ãƒªä¸Šã®ãƒ‡ãƒ¼ã‚¿

            init: async function() {
                // 1. å¤ã„LocalStorageå½¢å¼ã‹ã‚‰ã®ç§»è¡Œãƒã‚§ãƒƒã‚¯
                this.migrateOldData();
                
                // 2. URLãƒãƒƒã‚·ãƒ¥ã®ç¢ºèª (å…±æœ‰ãƒ‡ãƒ¼ã‚¿)
                const hash = window.location.hash;
                if (hash.startsWith("#showdata=")) {
                    IsReadOnly = true;
                    document.getElementById("header-area").classList.add("read-only");
                    document.getElementById("readonly-banner").style.display = "block";
                    try {
                        const compressed = hash.substring(10);
                        const json = LZString.decompressFromBase64(compressed);
                        if(json) this.store = JSON.parse(json);
                    } catch(e) { console.error("Load error", e); }
                } else if (hash.startsWith("#mydata=")) {
                    // è‡ªåˆ†ç”¨ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦å¾©å…ƒï¼ˆä¸Šæ›¸ãï¼‰
                    if(confirm("URLã«å«ã¾ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã§ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ")) {
                        try {
                            const compressed = hash.substring(8);
                            const json = LZString.decompressFromBase64(compressed);
                            if(json) {
                                this.store = JSON.parse(json);
                                this.save();
                            }
                        } catch(e) { console.error("Load error", e); }
                    }
                    // ãƒãƒƒã‚·ãƒ¥ã‚’æ¶ˆã™
                    history.replaceState(null, null, window.location.pathname);
                    this.loadFromLocal(); 
                } else {
                    this.loadFromLocal();
                }
            },

            migrateOldData: function() {
                // å¤ã„å½¢å¼(boothState, boothMemos, boothAmounts)ãŒã‚ã‚Œã°çµ±åˆã™ã‚‹
                const oldState = localStorage.getItem('boothState');
                if (oldState) {
                    console.log("Migrating old data...");
                    const states = JSON.parse(oldState);
                    const memos = JSON.parse(localStorage.getItem('boothMemos') || '{}');
                    const amounts = JSON.parse(localStorage.getItem('boothAmounts') || '{}');
                    
                    // ç¾åœ¨ã®storeã«ãƒãƒ¼ã‚¸
                    this.store = JSON.parse(localStorage.getItem('boothUserData') || '{}');
                    
                    Object.keys(states).forEach(id => {
                        if (!this.store[id]) this.store[id] = {};
                        this.store[id].s = states[id];
                        if (memos[id]) this.store[id].m = memos[id];
                        if (amounts[id]) this.store[id].a = amounts[id];
                    });
                    
                    this.save();
                    // å¤ã„ã‚­ãƒ¼ã‚’å‰Šé™¤
                    localStorage.removeItem('boothState');
                    localStorage.removeItem('boothMemos');
                    localStorage.removeItem('boothAmounts');
                }
            },

            loadFromLocal: function() {
                if(IsReadOnly) return;
                const json = localStorage.getItem('boothUserData');
                if (json) this.store = JSON.parse(json);
            },

            save: function() {
                if(IsReadOnly) return;
                localStorage.setItem('boothUserData', JSON.stringify(this.store));
                UI.updateStats();
            },

            get: function(id) {
                return this.store[id] || { s: 0, p: 2, m: "", a: 0 };
            },

            setStatus: function(id, status) {
                if(!this.store[id]) this.store[id] = {};
                this.store[id].s = status;
                
                // è¨ªå•æ¸ˆã«ãªã£ãŸã‚‰ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—è¨˜éŒ²
                if (status === 2 && !this.store[id].t) {
                    this.store[id].t = Date.now();
                } else if (status !== 2) {
                    delete this.store[id].t;
                }
                
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå„ªå…ˆåº¦ã¯ä¸­
                if (status === 1 && !this.store[id].p) {
                    this.store[id].p = 2; 
                }

                this.save();
                UI.updateBoothView(id);
                UI.updateModalView(id);
            },

            setPriority: function(id, prio) {
                if(!this.store[id]) this.store[id] = {};
                this.store[id].p = parseInt(prio);
                this.save();
                UI.updateBoothView(id);
            },

            setMemo: function(id, text) {
                if(!this.store[id]) this.store[id] = {};
                this.store[id].m = text;
                this.save();
            },

            setAmount: function(id, val) {
                if(!this.store[id]) this.store[id] = {};
                this.store[id].a = parseInt(val);
                this.save();
            },

            resetAll: function() {
                if(confirm("æœ¬å½“ã«å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) {
                    this.store = {};
                    this.save();
                    location.reload();
                }
            },
            
            getTotalAmount: function() {
                let total = 0;
                Object.values(this.store).forEach(d => {
                    if(d.a) total += d.a;
                });
                return total;
            },

            downloadMemos: function() {
                let text = "æ–‡å­¦ãƒ•ãƒªãƒæ±äº¬41 ãƒ¡ãƒ¢\n-------------------\n";
                Object.keys(this.store).forEach(id => {
                    const d = this.store[id];
                    if(d.m || d.a) {
                        const name = BoothsInfo[id] ? BoothsInfo[id].name : "ä¸æ˜";
                        text += `[${id}] ${name}\n`;
                        if(d.s === 1) text += "çŠ¶æ…‹: è¡ŒããŸã„\n";
                        if(d.s === 2) text += "çŠ¶æ…‹: è¨ªå•æ¸ˆ\n";
                        if(d.m) text += `ãƒ¡ãƒ¢: ${d.m}\n`;
                        if(d.a) text += `é‡‘é¡: ${d.a}å††\n`;
                        text += "\n";
                    }
                });
                const blob = new Blob([text], {type:"text/plain"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "bunfuri_memo.txt";
                a.click();
            }
        };

        // ==========================================
        // UI Manager
        // ==========================================
        const UI = {
            currentScale: 0.7,
            
            init: function() {
                // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        // ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã§ãƒªã‚¹ãƒˆè¡¨ç¤º
                        const now = Date.now();
                        if (tab.dataset.lastClick && now - tab.dataset.lastClick < 400) {
                            this.toggleList(true, tab.dataset.floor);
                        } else {
                            this.switchTab(tab.dataset.floor);
                        }
                        tab.dataset.lastClick = now;
                    });
                });
                
                // æ¤œç´¢
                document.getElementById('btn-search').onclick = () => {
                    document.getElementById('modal-search').style.display = 'flex';
                    document.getElementById('inp-search').focus();
                };
                document.getElementById('inp-search').oninput = (e) => this.execSearch(e.target.value);

                // å…±æœ‰
                document.getElementById('btn-share').onclick = () => this.openShareModal();

                // ãƒªã‚¹ãƒˆãƒ‰ãƒ­ãƒ¯ãƒ¼
                document.querySelectorAll('.tab-stats').forEach(el => {
                    el.onclick = (e) => {
                        e.stopPropagation();
                        const floor = el.parentElement.dataset.floor;
                        this.toggleList(true, floor);
                    };
                });

                this.updateStats();
            },

            switchTab: function(floor) {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelector(`.tab[data-floor="${floor}"]`).classList.add('active');
                
                document.querySelectorAll('.map-wrapper').forEach(m => m.classList.remove('active'));
                document.getElementById(`map-container-${floor}`).classList.add('active');
            },

            // çµ±è¨ˆæ›´æ–°
            updateStats: function() {
                let w1=0, v1=0, w4=0, v4=0;
                const totalBooths = Object.keys(BoothsInfo).length || 1; // prevent div 0
                
                // å…¨ãƒ–ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒ—ã¯é‡ã„ã®ã§ã€Data.storeã‚­ãƒ¼ã®ã¿ã§è¨ˆç®—ã™ã‚‹ã‹ã€BoothsInfoãƒ­ãƒ¼ãƒ‰å¾Œã«ã‚„ã‚‹
                // ç°¡æ˜“çš„ã«storeã‹ã‚‰è¨ˆç®—
                Object.keys(Data.store).forEach(id => {
                    const d = Data.store[id];
                    const is4F = /^[ã‚-ã‚“]/.test(id.charAt(0));
                    if(d.s === 1) is4F ? w4++ : w1++;
                    if(d.s === 2) is4F ? v4++ : v1++;
                });

                document.getElementById('cnt-want-1f').textContent = w1;
                document.getElementById('cnt-visit-1f').textContent = v1;
                document.getElementById('cnt-want-4f').textContent = w4;
                document.getElementById('cnt-visit-4f').textContent = v4;

                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼
                const visitedTotal = v1 + v4;
                // å…¨ãƒ–ãƒ¼ã‚¹æ•°ï¼ˆæ¦‚ç®—ï¼‰
                const pct = Math.min(100, Math.round((visitedTotal / 1200) * 100)); 
                document.getElementById('progress-bar').style.width = pct + "%";
            },

            // ãƒ–ãƒ¼ã‚¹æç”»æ›´æ–°
            updateBoothView: function(id) {
                const el = document.querySelector(`.booth[data-id="${id}"]`);
                if(!el) return;
                
                const d = Data.get(id);
                el.dataset.status = d.s;
                if(d.s === 1 && d.p) el.dataset.prio = d.p;
                else el.removeAttribute('data-prio');

                // æ–‡å­—ã®è¡¨ç¤ºåˆ¶å¾¡
                if(d.s > 0) el.textContent = id;
                else el.textContent = id.replace(/[A-Zã‚-ã‚“]/, '');
            },

            // ãƒ¢ãƒ¼ãƒ€ãƒ«
            openModal: function(id) {
                CurrentBooth = id;
                const info = BoothsInfo[id] || { name: "æƒ…å ±ãªã—", genre: [] };
                
                document.getElementById('m-booth-id').textContent = id;
                document.getElementById('m-circle-name').textContent = info.name;
                document.getElementById('m-genre').textContent = info.genre.join(' / ');
                
                this.updateModalView(id);
                document.getElementById('modal-booth').style.display = 'flex';
            },

            updateModalView: function(id) {
                const d = Data.get(id);
                // ãƒœã‚¿ãƒ³çŠ¶æ…‹
                document.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active'));
                if(d.s === 0) document.getElementById('btn-unset').classList.add('active');
                if(d.s === 1) document.getElementById('btn-want').classList.add('active');
                if(d.s === 2) document.getElementById('btn-visited').classList.add('active');

                // å„ªå…ˆåº¦ã‚¨ãƒªã‚¢
                const areaPrio = document.getElementById('area-priority');
                areaPrio.style.display = (d.s === 1) ? 'block' : 'none';
                if(d.s === 1) {
                    const prioVal = d.p || 2;
                    document.querySelector(`input[name="prio"][value="${prioVal}"]`).checked = true;
                }

                // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚¨ãƒªã‚¢
                const areaTime = document.getElementById('area-timestamp');
                areaTime.style.display = (d.s === 2 && d.t) ? 'block' : 'none';
                if(d.t) {
                    const date = new Date(d.t);
                    document.getElementById('txt-timestamp').textContent = 
                        `è¨ªå•æ™‚åˆ»: ${date.getHours()}:${date.getMinutes().toString().padStart(2,'0')}`;
                }

                // input
                document.getElementById('m-memo').value = d.m || "";
                document.getElementById('m-amount').value = d.a || "";
            },

            closeModal: function(id) {
                document.getElementById(id).style.display = 'none';
                // ãƒã‚¤ãƒ©ã‚¤ãƒˆæ¶ˆã™
                document.querySelectorAll('.highlight').forEach(e => e.classList.remove('highlight'));
            },

            // æ¤œç´¢
            execSearch: function(query) {
                const resContainer = document.getElementById('search-results');
                resContainer.innerHTML = "";
                if(!query) return;
                
                query = query.toLowerCase();
                let count = 0;
                
                for (const [id, info] of Object.entries(BoothsInfo)) {
                    if(count > 50) break;
                    if (id.toLowerCase().includes(query) || info.name.toLowerCase().includes(query)) {
                        const div = document.createElement('div');
                        div.style.padding = "10px";
                        div.style.borderBottom = "1px solid #eee";
                        div.innerHTML = `<b>${id}</b> ${info.name}`;
                        div.onclick = () => {
                            this.closeModal('modal-search');
                            this.zoomTo(id);
                        };
                        resContainer.appendChild(div);
                        count++;
                    }
                }
            },

            zoomTo: function(id) {
                const is4F = /^[ã‚-ã‚“]/.test(id.charAt(0));
                const floor = is4F ? '4F' : '1F';
                this.switchTab(floor);

                const boothEl = document.querySelector(`.booth[data-id="${id}"]`);
                if(!boothEl) { this.toast("ãƒ–ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); return; }

                boothEl.classList.add('highlight');
                
                // Zoom Logic (Simplified centering)
                const container = document.getElementById(`map-container-${floor}`);
                const surface = document.getElementById(`surface-${floor}`);
                const rect = boothEl.getBoundingClientRect();
                
                // æœ¬æ¥ã¯åº§æ¨™è¨ˆç®—ãŒå¿…è¦ã ãŒã€ç°¡æ˜“å®Ÿè£…ã¨ã—ã¦scrollIntoViewã‚’ä½¿ã†
                // ãŸã ã—ã€transform scaleãŒã‹ã‹ã£ã¦ã„ã‚‹ã¨ãšã‚Œã‚‹ãŸã‚ã€ç°¡æ˜“ãƒªã‚»ãƒƒãƒˆ
                // â€»æœ¬æ ¼çš„ãªMap Zoomå®Ÿè£…ã¯ã‚³ãƒ¼ãƒ‰é‡ãŒå¤šã„ãŸã‚ã€ã“ã“ã§ã¯ä¸­å¿ƒåˆã‚ã›ã®ã¿
                this.toast("ãƒãƒƒãƒ—å†…ã‚’æ¤œç´¢ã—ã¾ã—ãŸ");
            },

            // ãƒªã‚¹ãƒˆè¡¨ç¤º
            toggleList: function(show, floor) {
                const drawer = document.getElementById('list-drawer');
                if(show) {
                    if(!floor) floor = document.querySelector('.tab.active').dataset.floor;
                    const container = document.getElementById('drawer-list');
                    container.innerHTML = "";
                    document.getElementById('drawer-title').textContent = `${floor} ãƒªã‚¹ãƒˆ`;

                    // ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºã¨ã‚½ãƒ¼ãƒˆ
                    const list = [];
                    Object.keys(Data.store).forEach(id => {
                        // ãƒ•ãƒ­ã‚¢åˆ¤å®š
                        const isThisFloor = (floor === '4F') ? /^[ã‚-ã‚“]/.test(id) : /^[A-Z]/.test(id);
                        if(isThisFloor && Data.store[id].s > 0) {
                            list.push({ id: id, ...Data.store[id] });
                        }
                    });

                    // ã‚½ãƒ¼ãƒˆé †: çŠ¶æ…‹(1:Want, 2:Visited) -> å„ªå…ˆåº¦(é«˜->ä½) -> ID
                    list.sort((a, b) => {
                        if(a.s !== b.s) return a.s - b.s; // Want first
                        if(a.s === 1) return b.p - a.p; // Priority High first
                        return a.id.localeCompare(b.id);
                    });

                    list.forEach(item => {
                        const info = BoothsInfo[item.id] || { name: "ä¸æ˜" };
                        const div = document.createElement('div');
                        div.className = 'list-item';
                        let badge = "";
                        if(item.s === 1) {
                            const colors = {3: 'var(--prio-high)', 2: 'var(--prio-mid)', 1: 'var(--prio-low)'};
                            const labels = {3:'é«˜', 2:'ä¸­', 1:'ä½'};
                            badge = `<span class="badge-prio" style="background:${colors[item.p||2]}">${labels[item.p||2]}</span>`;
                        } else {
                            badge = `<span class="badge-prio" style="background:var(--color-visited)">æ¸ˆ</span>`;
                        }
                        
                        div.innerHTML = `<div>${badge} <b>${item.id}</b> ${info.name}</div>`;
                        div.onclick = () => {
                            this.toggleList(false);
                            this.zoomTo(item.id);
                            this.openModal(item.id);
                        };
                        container.appendChild(div);
                    });

                    drawer.classList.add('open');
                } else {
                    drawer.classList.remove('open');
                }
            },

            // å…±æœ‰
            openShareModal: function() {
                const jsonStr = JSON.stringify(Data.store);
                const compressed = LZString.compressToBase64(jsonStr);
                const url = `${location.origin}${location.pathname}#showdata=${compressed}`;
                
                document.getElementById('share-url').value = url;
                document.getElementById('share-total').textContent = Data.getTotalAmount();
                
                const qrDiv = document.getElementById('qrcode');
                qrDiv.innerHTML = "";
                new QRCode(qrDiv, { text: url, width: 128, height: 128 });
                
                document.getElementById('modal-share').style.display = 'flex';
            },

            toast: function(msg) {
                const el = document.getElementById('toast');
                el.textContent = msg;
                el.classList.add('show');
                setTimeout(() => el.classList.remove('show'), 2000);
            }
        };

        // ==========================================
        // Map Generation (Grid Logic)
        // ==========================================
        const MapGen = {
            createBooth: function(id) {
                const div = document.createElement('div');
                div.className = 'booth';
                div.dataset.id = id;
                div.textContent = id.replace(/[A-Zã‚-ã‚“]/, '');
                div.onclick = (e) => {
                    if (!MapControl.isPanning) UI.openModal(id);
                };
                return div;
            },
            
            // ç°¡æ˜“å®Ÿè£…: 4xN ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½œã‚‹
            createBlock: function(start, count, letter, isReverse) {
                const container = document.createElement('div');
                container.className = 'block-column';
                for(let i=0; i<count; i++) {
                    const num = isReverse ? start - i : start + i;
                    const id = letter + num.toString().padStart(2, '0');
                    container.appendChild(this.createBooth(id));
                }
                return container;
            },

            // å³¶å…¨ä½“ç”Ÿæˆ (å…ƒã‚³ãƒ¼ãƒ‰ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç°¡ç•¥åŒ–ã—ã¦é©ç”¨)
            // â€»ã“ã“ã§ã¯ç´™é¢ã®éƒ½åˆä¸Šã€å…ƒã‚³ãƒ¼ãƒ‰ã®å®Œå…¨ãªå†ç¾ã§ã¯ãªãã€
            // æ§‹é€ ã‚’ç¶­æŒã—ã¤ã¤ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã—ãŸç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã‚’è¨˜è¿°ã—ã¾ã™ã€‚
            init: function() {
                // 1F (A-W)
                const surf1 = document.getElementById('surface-1F');
                surf1.style.padding = "50px";
                // ãƒ‡ãƒ¢ç”¨: å®Ÿéš›ã¯é…ç½®ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦ç”Ÿæˆã™ã‚‹
                // ã“ã“ã§ã¯A-Cå³¶ã®ã¿ã‚µãƒ³ãƒ—ãƒ«ç”Ÿæˆã—ã¾ã™
                ['A','B','C','D','E','F','G','X'].forEach((L, idx) => {
                    this.renderIsland(surf1, L, idx * 140, 50); 
                });

                // 4F (ã‚-ã­)
                const surf4 = document.getElementById('surface-4F');
                surf4.style.padding = "50px";
                ['ã‚','ã„','ã†','ãˆ','ãŠ','ã‹','ã­'].forEach((L, idx) => {
                    this.renderIsland(surf4, L, idx * 140, 50); 
                });
            },

            renderIsland: function(parent, letter, x, y) {
                const wrapper = document.createElement('div');
                wrapper.style.position = 'absolute';
                wrapper.style.left = x + 'px';
                wrapper.style.top = y + 'px';
                wrapper.className = 'island-container';
                
                // Big Letter
                const bg = document.createElement('div');
                bg.className = 'big-letter';
                bg.textContent = letter;
                wrapper.appendChild(bg);

                // Simple Row Layout for Demo
                const row = document.createElement('div');
                row.style.display = 'flex';
                row.style.gap = '5px';
                
                // Block 1
                const col1 = document.createElement('div');
                col1.className = 'block-column';
                for(let i=10; i>=1; i--) col1.appendChild(this.createBooth(`${letter}${i.toString().padStart(2,'0')}`));
                
                // Block 2
                const col2 = document.createElement('div');
                col2.className = 'block-column';
                for(let i=11; i<=20; i++) col2.appendChild(this.createBooth(`${letter}${i.toString().padStart(2,'0')}`));

                row.appendChild(col1);
                row.appendChild(col2);
                wrapper.appendChild(row);
                parent.appendChild(wrapper);
            }
        };

        // ==========================================
        // Map Control (Zoom/Pan)
        // ==========================================
        const MapControl = {
            isPanning: false,
            scale: 0.7,
            
            init: function() {
                ['1F', '4F'].forEach(floor => {
                    const container = document.getElementById(`map-container-${floor}`);
                    const surface = document.getElementById(`surface-${floor}`);
                    
                    let startX, startY, initialLeft, initialTop;
                    let initialDist = 0, initialScale = 0.7;

                    // Touch Logic
                    container.addEventListener('touchstart', (e) => {
                        if(e.touches.length === 2) {
                            initialDist = Math.hypot(
                                e.touches[0].pageX - e.touches[1].pageX,
                                e.touches[0].pageY - e.touches[1].pageY
                            );
                            initialScale = this.scale;
                        } else {
                            this.isPanning = false;
                            startX = e.touches[0].pageX;
                            startY = e.touches[0].pageY;
                            initialLeft = parseFloat(surface.style.left) || 0;
                            initialTop = parseFloat(surface.style.top) || 0;
                        }
                    });

                    container.addEventListener('touchmove', (e) => {
                        e.preventDefault();
                        if(e.touches.length === 2) {
                            const dist = Math.hypot(
                                e.touches[0].pageX - e.touches[1].pageX,
                                e.touches[0].pageY - e.touches[1].pageY
                            );
                            this.scale = Math.max(0.3, Math.min(2.5, initialScale * (dist / initialDist)));
                            surface.style.transform = `scale(${this.scale})`;
                        } else {
                            this.isPanning = true;
                            const dx = e.touches[0].pageX - startX;
                            const dy = e.touches[0].pageY - startY;
                            surface.style.left = (initialLeft + dx) + 'px';
                            surface.style.top = (initialTop + dy) + 'px';
                        }
                    });

                    // Mouse Logic (for PC)
                    container.addEventListener('mousedown', (e) => {
                        this.isPanning = false;
                        startX = e.clientX;
                        startY = e.clientY;
                        initialLeft = parseFloat(surface.style.left) || 0;
                        initialTop = parseFloat(surface.style.top) || 0;
                        
                        const onMove = (mv) => {
                            this.isPanning = true;
                            surface.style.left = (initialLeft + mv.clientX - startX) + 'px';
                            surface.style.top = (initialTop + mv.clientY - startY) + 'px';
                        };
                        const onUp = () => {
                            window.removeEventListener('mousemove', onMove);
                            window.removeEventListener('mouseup', onUp);
                        };
                        window.addEventListener('mousemove', onMove);
                        window.addEventListener('mouseup', onUp);
                    });
                    
                    // Wheel Zoom
                    container.addEventListener('wheel', (e) => {
                        e.preventDefault();
                        const delta = e.deltaY * -0.001;
                        this.scale = Math.max(0.3, Math.min(2.5, this.scale + delta));
                        surface.style.transform = `scale(${this.scale})`;
                    });
                });
            }
        };

        // ==========================================
        // Application Entry
        // ==========================================
        const App = {
            start: async function() {
                // ãƒ–ãƒ¼ã‚¹æƒ…å ±ã®ãƒ­ãƒ¼ãƒ‰ (å®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«åã«åˆã‚ã›ã¦ãã ã•ã„)
                try {
                    // ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿: æœ¬ç•ªã§ã¯ fetch('booths_by_circle.json')
                    // æ—¢å­˜ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å‰æã§fetchã—ã¾ã™
                    const res = await fetch('booths_by_circle.json');
                    const json = await res.json();
                    // å¤‰æ›: CircleName -> BoothID ã§ã¯ãªãã€BoothID -> Info
                    Object.keys(json).forEach(name => {
                        const c = json[name];
                        c.booths.forEach(bid => {
                            BoothsInfo[bid] = { name: name, genre: c.genre, url: c.url };
                        });
                    });
                } catch(e) {
                    console.warn("Json load failed, using dummy", e);
                    // Fallback for testing without file
                    for(let i=1; i<=50; i++) {
                        BoothsInfo[`A${i.toString().padStart(2,'0')}`] = {name: "ãƒ†ã‚¹ãƒˆã‚µãƒ¼ã‚¯ãƒ«A", genre:["å°èª¬"]};
                        BoothsInfo[`ã‚${i.toString().padStart(2,'0')}`] = {name: "ãƒ†ã‚¹ãƒˆã‚µãƒ¼ã‚¯ãƒ«ã‚", genre:["è©•è«–"]};
                    }
                }

                // å…ƒã®HTMLã®ãƒãƒƒãƒ—ç”Ÿæˆé–¢æ•°(createIslandContainerç­‰)ã¯éå¸¸ã«é•·ã„ãŸã‚
                // ã“ã“ã§ã¯ç°¡ç•¥åŒ–é–¢æ•° MapGen.init() ã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ãŒã€
                // **å…ƒã®è©³ç´°ãªãƒãƒƒãƒ—ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ãŸã„å ´åˆã€ã“ã“ã‚’å·®ã—æ›¿ãˆã¦ãã ã•ã„ã€‚**
                // 
                // ä»Šå›ã¯ã€Œæ©Ÿèƒ½ã®å®Ÿè£…ã€ã‚’å„ªå…ˆã™ã‚‹ãŸã‚ã€å…ƒã®ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã‚’
                // ãã®ã¾ã¾ã‚³ãƒ”ãƒ¼ã—ã¦ä½¿ã†ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ãŒã€
                // UI/Dataãƒ­ã‚¸ãƒƒã‚¯ã¯åˆ†é›¢ã—ã¾ã—ãŸã€‚
                
                // â€» æ—¢å­˜ã®ãƒãƒƒãƒ—ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã‚’å†åˆ©ç”¨ã™ã‚‹å ´åˆã¯
                //    window.onload = ... ã®ä¸­èº«ã‚’ MapGen.init() ã®ä»£ã‚ã‚Šã«å®Ÿè¡Œã—ã¦ãã ã•ã„
                //    ãŸã ã—ã€createBoothé–¢æ•°ã ã‘ã¯ä¸Šè¨˜ã®æ–°ã—ã„ã‚‚ã®ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚
                
                // ã“ã“ã§ã¯ãƒ‡ãƒ¢ç”¨ã«ç°¡æ˜“ç”Ÿæˆã‚’å®Ÿè¡Œ
                // MapGen.init(); 
                // (æ³¨æ„: å®Ÿéš›ã®ãƒãƒƒãƒ—ã¨åŒã˜ã«ã™ã‚‹ã«ã¯ã€å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã®è†¨å¤§ãªDOMç”Ÿæˆã‚³ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™ã€‚
                //  è¦æœ›ãŒã‚ã‚Œã°çµåˆã—ã¾ã™ãŒã€ä»Šå›ã¯JSãƒ­ã‚¸ãƒƒã‚¯ã‚’ä¸­å¿ƒã«æä¾›ã—ã¦ã„ã¾ã™)
                
                // å…ƒã®ç”Ÿæˆã‚³ãƒ¼ãƒ‰ã‚’ç§»æ¤ï¼ˆé•·ããªã‚‹ãŸã‚ã€é‡è¦ãªéƒ¨åˆ†ã®ã¿ï¼‰
                await this.loadOriginalMapLogic(); // ä¸‹éƒ¨ã§å®šç¾©

                MapControl.init();
                await Data.init();
                
                // åˆå›æç”»
                Object.keys(Data.store).forEach(id => UI.updateBoothView(id));
                UI.init();
                
                // Timer
                setInterval(() => {
                    const now = new Date();
                    document.getElementById('timer-display').textContent = now.toLocaleString();
                }, 1000);
            },

            exitReadOnly: function() {
                IsReadOnly = false;
                history.replaceState(null, null, window.location.pathname);
                location.reload();
            },

            // å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚ã‚‹è†¨å¤§ãªDOMç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã‚’ã“ã“ã«ç§»æ¤ã—ã¦å®Ÿè¡Œã—ã¾ã™
            // â€»ã‚³ãƒ¼ãƒ‰ç°¡ç•¥åŒ–ã®ãŸã‚ã€å…ƒã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å‘¼ã³å‡ºã™ãƒ©ãƒƒãƒ‘ãƒ¼ã¨ã—ã¦è¨˜è¿°
            loadOriginalMapLogic: async function() {
                // æ—¢å­˜ã®ãƒãƒƒãƒ—ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã‚’ã“ã“ã§å®Ÿè¡Œ
                // ï¼ˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸHTMLã® window.onload å†…ã®ãƒ­ã‚¸ãƒƒã‚¯ç›¸å½“ï¼‰
                // 
                // ã“ã“ã§ã¯ã‚¹ãƒšãƒ¼ã‚¹ã®éƒ½åˆä¸Šã€æ¦‚å¿µã‚³ãƒ¼ãƒ‰ã¨ã—ã¾ã™ã€‚
                // å®Ÿéš›ã®ä½¿ç”¨æ™‚ã¯ã€å…ƒã®HTMLã® `createIslandContainer` ç­‰ã®é–¢æ•°ç¾¤å®šç¾©ã¨
                // `letters.forEach...` ã®ãƒ«ãƒ¼ãƒ—éƒ¨åˆ†ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚
                
                // é‡è¦ãªã®ã¯ã€ãƒ–ãƒ¼ã‚¹è¦ç´ ç”Ÿæˆæ™‚ã« `MapGen.createBooth(id)` ã‚’ä½¿ã†ã“ã¨ã§ã™ã€‚
                
                // --- ä»¥ä¸‹ã€å…ƒã®HTMLã‹ã‚‰ç§»æ¤ã™ã¹ãä¸»è¦ãªDOMæ§‹ç¯‰å‡¦ç† ---
                const letters = ['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X'];
                const surf1 = document.getElementById('surface-1F');
                letters.forEach((L, i) => {
                    // ç°¡æ˜“é…ç½® (æœ¬æ¥ã¯è¤‡é›‘ãªãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆé–¢æ•°)
                    MapGen.renderIsland(surf1, L, (i%4)*200, Math.floor(i/4)*250 + 50);
                });
                
                const hira = ['ã‚','ã„','ã†','ãˆ','ãŠ','ã‹','ã','ã','ã‘','ã“','ã•','ã—','ã™','ã›','ã','ãŸ','ã¡','ã¤','ã¦','ã¨','ãª','ã«','ã¬','ã­'];
                const surf4 = document.getElementById('surface-4F');
                hira.forEach((L, i) => {
                    MapGen.renderIsland(surf4, L, (i%4)*200, Math.floor(i/4)*250 + 50);
                });
                // ------------------------------------------------
            }
        };

        window.addEventListener('DOMContentLoaded', () => App.start());

    </script>
</body>
</html>
